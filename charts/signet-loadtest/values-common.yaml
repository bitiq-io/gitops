name: signet-loadtest

replicaCount: 0

image:
  repository: grafana/k6
  tag: 0.49.0
  pullPolicy: IfNotPresent

serviceAccount:
  create: false
  name: ""

env:
  llmBaseUrl: ""
  embeddingsBaseUrl: ""
  token:
    secretName: openshift-ai-token
    secretKey: token
  extra: []

envFrom: []

resources:
  requests:
    cpu: 50m
    memory: 64Mi
  limits:
    cpu: 500m
    memory: 512Mi

script:
  fileName: loadtest.js
  contents: |
    import http from 'k6/http';
    import { sleep } from 'k6';

    export const options = {
      insecureSkipTLSVerify: true,
      scenarios: {
        chat_bursty: {
          executor: 'ramping-vus',
          startVUs: 2,
          stages: [
            { duration: '2m', target: 8 },
            { duration: '3m', target: 25 },
            { duration: '2m', target: 6 },
            { duration: '3m', target: 35 },
            { duration: '2m', target: 0 },
          ],
          gracefulRampDown: '30s',
          exec: 'runChat',
        },
        embeddings_bursty: {
          executor: 'ramping-vus',
          startVUs: 2,
          stages: [
            { duration: '2m', target: 10 },
            { duration: '3m', target: 30 },
            { duration: '2m', target: 10 },
            { duration: '3m', target: 40 },
            { duration: '2m', target: 0 },
          ],
          gracefulRampDown: '30s',
          exec: 'runEmbeddings',
        },
      },
    };

    const token = __ENV.OPENSHIFT_AI_TOKEN;
    const chatBase = __ENV.LLM_BASE_URL;
    const embedBase = __ENV.EMBEDDINGS_BASE_URL;

    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function randomText(len) {
      const chunk = "signet nostr reputation receipts ";
      return chunk.repeat(Math.ceil(len / chunk.length)).slice(0, len);
    }

    function buildHeaders() {
      const headers = {
        'Content-Type': 'application/json',
      };

      if (token) {
        headers.Authorization = `Bearer ${token}`;
      }

      return headers;
    }

    export function runChat() {
      if (!chatBase) {
        sleep(1);
        return;
      }

      const headers = buildHeaders();
      const maxTokens = randInt(96, 512);
      const promptLen = randInt(400, 5000);
      const body = JSON.stringify({
        model: "signet-llm",
        messages: [
          { role: "system", content: "You are a concise assistant." },
          { role: "user", content: randomText(promptLen) + "\\nSummarize in bullets with actionable steps." }
        ],
        max_tokens: maxTokens,
        temperature: Math.random(),
        stream: false
      });

      http.post(`${chatBase}/v1/chat/completions`, body, { headers });
      sleep(Math.random() * 1.5);
    }

    export function runEmbeddings() {
      if (!embedBase) {
        sleep(1);
        return;
      }

      const headers = buildHeaders();
      const batchSize = randInt(8, 32);
      const itemLen = randInt(200, 2000);
      const input = Array.from({ length: batchSize }, () => randomText(itemLen));

      const body = JSON.stringify({
        model: "signet-embeddings",
        input
      });

      http.post(`${embedBase}/v1/embeddings`, body, { headers });
      sleep(Math.random() * 1.2);
    }
