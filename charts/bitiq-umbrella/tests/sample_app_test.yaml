suite: Sample app Application annotations
templates:
  - templates/app-bitiq-sample-app.yaml
release:
  name: umbrella
  namespace: openshift-gitops
tests:
  - it: sets multi-image annotations and env label
    set:
      env: local
    asserts:
      - equal:
          path: metadata.annotations["argocd-image-updater.argoproj.io/image-list"]
          value: "backend=quay.io/paulcapestany/toy-service,frontend=quay.io/paulcapestany/toy-web"
      - equal:
          path: metadata.annotations["argocd-image-updater.argoproj.io/backend.helm.image-name"]
          value: backend.image.repository
      - equal:
          path: metadata.annotations["argocd-image-updater.argoproj.io/frontend.helm.image-name"]
          value: frontend.image.repository
      - equal:
          path: metadata.annotations["argocd-image-updater.argoproj.io/backend.allow-tags"]
          value: "regexp:^v\\d+\\.\\d+\\.\\d+-commit\\.[0-9a-f]{7,}$"
      - equal:
          path: metadata.annotations["argocd-image-updater.argoproj.io/frontend.allow-tags"]
          value: "regexp:^v\\d+\\.\\d+\\.\\d+-commit\\.[0-9a-f]{7,}$"
      - equal:
          path: metadata.labels["bitiq.io/env"]
          value: local
  - it: includes env value file layering and ignoreMissingValueFiles
    set:
      env: sno
    asserts:
      - contains:
          path: spec.source.helm.valueFiles
          content: values-common.yaml
      - contains:
          path: spec.source.helm.valueFiles
          content: values-sno.yaml
      - contains:
          path: spec.source.helm.valueFiles
          content: values-sno-local.yaml
      - equal:
          path: spec.source.helm.ignoreMissingValueFiles
          value: true
  - it: omits backend annotations when backend pause is true
    set:
      env: local
      imageUpdater:
        pause:
          backend: true
    asserts:
      - equal:
          path: metadata.annotations["argocd-image-updater.argoproj.io/image-list"]
          value: "frontend=quay.io/paulcapestany/toy-web"
      - notExists:
          path: metadata.annotations["argocd-image-updater.argoproj.io/backend.helm.image-name"]
      - exists:
          path: metadata.annotations["argocd-image-updater.argoproj.io/frontend.helm.image-name"]
  - it: omits frontend annotations when frontend pause is true
    set:
      env: local
      imageUpdater:
        enableFrontend: true
        pause:
          frontend: true
    asserts:
      - equal:
          path: metadata.annotations["argocd-image-updater.argoproj.io/image-list"]
          value: "backend=quay.io/paulcapestany/toy-service"
      - exists:
          path: metadata.annotations["argocd-image-updater.argoproj.io/backend.helm.image-name"]
      - notExists:
          path: metadata.annotations["argocd-image-updater.argoproj.io/frontend.helm.image-name"]
  - it: omits write-back annotations when both services are paused
    set:
      env: local
      imageUpdater:
        pause:
          backend: true
          frontend: true
    asserts:
      - notExists:
          path: metadata.annotations["argocd-image-updater.argoproj.io/write-back-method"]
      - notExists:
          path: metadata.annotations["argocd-image-updater.argoproj.io/write-back-target"]
      - notExists:
          path: metadata.annotations["argocd-image-updater.argoproj.io/git-branch"]
      - notExists:
          path: metadata.annotations["argocd-image-updater.argoproj.io/dry-run"]
      - notExists:
          path: metadata.annotations["argocd-image-updater.argoproj.io/interval"]
