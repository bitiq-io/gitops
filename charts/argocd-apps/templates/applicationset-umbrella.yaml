apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: bitiq-umbrella-by-env
  namespace: {{ .Values.argocdNamespace }}
  labels:
    # Ensure the ApplicationSet controller for this Argo CD instance reconciles this resource
    argocd.argoproj.io/instance: {{ .Values.argocdInstanceName | quote }}
spec:
  goTemplate: true
  generators:
    - list:
        elements:
{{- range $e := .Values.envs }}
{{- if or (eq $.Values.envFilter "" ) (eq $.Values.envFilter $e.name) }}
          - env: {{ $e.name }}
            cluster: {{ $e.clusterServer | quote }}
            baseDomain: {{ default $e.baseDomain $.Values.baseDomainOverride | quote }}
            appNamespace: {{ $e.appNamespace | quote }}
            platforms: {{ $e.platforms | quote }}
            toyServiceUpdaterEnabled: {{ default true $e.toyServiceImageUpdater.enabled }}
            toyServiceUpdaterPause: {{ default false $e.toyServiceImageUpdater.pause }}
            toyWebUpdaterPause: {{ default false $e.toyWebImageUpdater.pause }}
            tektonFsGroup: {{ $e.tektonFsGroup | quote }}
            vaultRuntimeEnabled: {{ default false $e.vaultRuntimeEnabled }}
            vaultRuntimeAddress: {{ $e.vaultRuntimeAddress | quote }}
            vaultRuntimeKubernetesMount: {{ $e.vaultRuntimeKubernetesMount | default "kubernetes" | quote }}
            vaultRuntimeRoleName: {{ $e.vaultRuntimeRoleName | quote }}
            vaultConfigEnabled: {{ default false $e.vaultConfigEnabled }}
            vaultConfigAddress: {{ $e.vaultConfigAddress | quote }}
            vaultConfigKubernetesHost: {{ $e.vaultConfigKubernetesHost | default "https://kubernetes.default.svc" | quote }}
            vaultConfigMountPath: {{ $e.vaultConfigMountPath | default "kubernetes" | quote }}
            vaultConfigConnectionRole: {{ $e.vaultConfigConnectionRole | default "kube-auth" | quote }}
            vaultConfigRoleName: {{ $e.vaultConfigRoleName | quote }}
            vaultConfigPolicyName: {{ $e.vaultConfigPolicyName | quote }}
{{- end }}
{{- end }}
  template:
    metadata:
      name: 'bitiq-umbrella-{{ "{{ .env }}" }}'
      labels:
        bitiq.io/env: '{{ "{{ .env }}" }}'
        app.kubernetes.io/name: bitiq-umbrella
        app.kubernetes.io/managed-by: argocd
    spec:
      project: default
      source:
        repoURL: {{ .Values.repoUrl | quote }}
        targetRevision: {{ .Values.targetRevision | quote }}
        path: charts/bitiq-umbrella
        helm:
          parameters:
            - name: env
              value: '{{ "{{ .env }}" }}'
            - name: baseDomain
              value: '{{ "{{ .baseDomain }}" }}'
            - name: appNamespace
              value: '{{ "{{ .appNamespace }}" }}'
            - name: repoUrl
              value: {{ .Values.repoUrl | quote }}
            - name: targetRevision
              value: {{ .Values.targetRevision | quote }}
            - name: imageUpdater.platforms
              value: '{{ "{{ .platforms }}" }}'
            - name: imageUpdater.toyService.enabled
              value: '{{ "{{ .toyServiceUpdaterEnabled | default true }}" }}'
            - name: imageUpdater.toyService.pause
              value: '{{ "{{ .toyServiceUpdaterPause | default false }}" }}'
            - name: imageUpdater.toyWeb.pause
              value: '{{ "{{ .toyWebUpdaterPause | default false }}" }}'
            - name: strfry.enabled
              value: '{{ "{{ .strfryEnabled | default false }}" }}'
            - name: couchbase.enabled
              value: '{{ "{{ .couchbaseEnabled | default false }}" }}'
            - name: certManager.enabled
              value: '{{ "{{ .certManagerEnabled | default false }}" }}'
            - name: strfry.enabled
              value: '{{ "{{ .strfryEnabled | default false }}" }}'
            - name: couchbase.enabled
              value: '{{ "{{ .couchbaseEnabled | default false }}" }}'
            - name: ciPipelines.fsGroup
              value: '{{ "{{ .tektonFsGroup }}" }}'
            - name: ciPipelines.eventListener.debugLogging
              value: '{{ "{{ false }}" }}'
            - name: vault.runtime.enabled
              value: '{{ "{{ .vaultRuntimeEnabled | default false }}" }}'
            - name: vault.runtime.address
              value: '{{ "{{ .vaultRuntimeAddress }}" }}'
            - name: vault.runtime.kubernetesMount
              value: '{{ "{{ .vaultRuntimeKubernetesMount }}" }}'
            - name: vault.runtime.roleName
              value: '{{ "{{ .vaultRuntimeRoleName }}" }}'
            - name: vault.config.enabled
              value: '{{ "{{ .vaultConfigEnabled | default false }}" }}'
            - name: vault.config.address
              value: '{{ "{{ .vaultConfigAddress }}" }}'
            - name: vault.config.kubernetesHost
              value: '{{ "{{ .vaultConfigKubernetesHost }}" }}'
            - name: vault.config.mountPath
              value: '{{ "{{ .vaultConfigMountPath }}" }}'
            - name: vault.config.connectionRole
              value: '{{ "{{ .vaultConfigConnectionRole }}" }}'
            - name: vault.config.roleName
              value: '{{ "{{ .vaultConfigRoleName }}" }}'
            - name: vault.config.policyName
              value: '{{ "{{ .vaultConfigPolicyName }}" }}'
      destination:
        server: '{{ "{{ .cluster }}" }}'
        namespace: '{{ "{{ .appNamespace }}" }}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
