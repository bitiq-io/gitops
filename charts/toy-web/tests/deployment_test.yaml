suite: Deployment container image
templates:
  - templates/deployment.yaml
values:
  - ../values-common.yaml
release:
  name: toy-web
  namespace: bitiq-local
tests:
  - it: includes API_BASE_URL secret ref by default
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: API_BASE_URL
            valueFrom:
              secretKeyRef:
                name: toy-web-config
                key: API_BASE_URL
  - it: renders deployment with default image
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: quay.io/paulcapestany/toy-web:v0.0.0-commit.0000000
  - it: allows overriding image tag
    set:
      image:
        repository: quay.io/example/frontend
        tag: v1.2.3-commit.abc1234
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: quay.io/example/frontend:v1.2.3-commit.abc1234
  - it: renders frontend env overrides
    set:
      frontend:
        env:
          - name: FEATURE_FLAG
            value: enabled
        secret:
          enabled: true
          name: toy-web-config
          items:
            - name: API_TOKEN
              key: apiToken
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: FEATURE_FLAG
            value: enabled
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: API_TOKEN
            valueFrom:
              secretKeyRef:
                name: toy-web-config
                key: apiToken
